name: Daily DeFi Systemic Risk Update

on:
  schedule:
    - cron: '0 2 * * *'   # 02:00 UTC daily
  workflow_dispatch:
    inputs:
      date:
        description: 'Target date YYYY-MM-DD (default: today)'
        required: false
        default: ''

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - run: pip install -r requirements.txt

      - name: Run pipeline
        env:
          GRAPH_API_KEY:      ${{ secrets.GRAPH_API_KEY }}
          GLASSNODE_API_KEY:  ${{ secrets.GLASSNODE_API_KEY }}
          COINGECKO_API_KEY:  ${{ secrets.COINGECKO_API_KEY }}
          PEG_WARN_THRESHOLD:     ${{ vars.PEG_WARN_THRESHOLD || '0.005' }}
          PEG_CRITICAL_THRESHOLD: ${{ vars.PEG_CRITICAL_THRESHOLD || '0.02' }}
          CASCADE_DROPS:          ${{ vars.CASCADE_DROPS || '0.10,0.20,0.30,0.40,0.50' }}
          BRIDGE_DROP_PCT:        ${{ vars.BRIDGE_DROP_PCT || '20' }}
        run: python src/pipeline.py

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "data: daily DeFi update $(date -u +%Y-%m-%d)"
          file_pattern: "data/**"
          commit_user_name: "defi-risk-bot"
          commit_user_email: "defi-risk-bot@users.noreply.github.com"
